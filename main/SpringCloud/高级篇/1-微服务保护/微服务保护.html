<!doctype html>
<html style='font-size:18px !important'>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<link href="https://raw.githubusercontent.com/Curi-T/picture/main/CuriT-ico/favicon.ico" rel="shortcut icon">
<style>
#O-switch, .typora-export-sidebar {
    -moz-user-select: none; 
    -webkit-user-select: none; 
    -ms-user-select: none; 
    -khtml-user-select: none; 
    user-select: none;
}
</style>
<link href='https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap' rel='stylesheet' type='text/css' /><link href='https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500&display=swap' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


/* 基于 rainbow 主题 */
/*
fonts initalization
*/
@import url(https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap);
@import url(https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500&display=swap);

@page {
	size: A4;
	margin: 8mm 0mm;
}

/*
root variables including colors, font-familys and a shadow style
*/
:root {
	--bg-color: #f3f2ee;
	--font--family: "宋体", "思源黑体 CN", "微软雅黑";
	--monospace-font: "Source Code Pro Regular", "Source Code Pro", monospace;
	--font--family-h1: "方正楷体_GBK", "微软雅黑";
	--font--family-h2: "华康手札体W5P", "微软雅黑";

	--color--h2--quote: #2d7d59;
	/* 二级标题背景颜色、引用侧边颜色*/
	--color--quote--backgroudn: rgba(66, 185, 131, 0.1);
	/*引用背景颜色*/
	--color--h--focus: #ff5d52;
	/* 标题点击后的前缀提示颜色 */

	--color--inlinecode--font: #D83B64;
	/*行内代码字体颜色*/
	--color--inlinecode--background: #f9f2f4;
	/*行内代码背景2颜色*/
	--color--url: #659ddc;
	/*超链接字体颜色*/
	--color--url--focus: #f60;
	/*选中的超链接后的填充颜色*/
	--color--url--focus--font: #ffffffe6;
	/*选中的超链接后的字体颜色*/
	--color--highlight: #ffff00;
	/*高亮颜色*/
	--del-color: rgb(151, 151, 151);
	/*删除线颜色*/
	--italic-color: gray;
	/*斜体颜色*/
	--strong-color: brown;
	/*粗体颜色*/
	--underline-color: #f00;
	/*下划线颜色*/
	--ol-color: #81accf;
	/* 有序列表前缀颜色 */
	--olfore-color: #fff;
	/* 有序列表字体颜色 */

	--h-border-color: rgb(255, 191, 191);
	--h-bg-color: rgb(255, 232, 232);
	--table-border-color: rgb(255, 235, 211);
	--th-bg-color: rgb(255, 243, 228);
	--tr-bg-color: rgb(255, 249, 242);
	--tr-hover-bg-color: rgb(254, 255, 230);
	--code-bg-color: rgb(247, 247, 247);

	--selection-bg-color: rgb(235, 227, 255);
	--block-shadow: 0.15rem 0.15rem 0.5rem rgb(150, 150, 150);

	--focus-color: #ff5d52; /* 点击某些元素（如标题）显示的颜色（偏红） */
	--ulol-color: #81accf; /* 有序无序列表前缀颜色（灰色） */
    --olfore-color: #fff; /* 有序列表字体颜色（白色） */
    --taskborder-color: #81accf; /* 任务列表边框色（红色） */
    --taskfocus-color: #81accf; /* 任务列表选中填充色（绿色） */

}

html {
	background-color: #f3f2ee;
	font-size: 16px;
}

body {
	background-color: #f3f2ee;
}


#write {
	font-family: var(--font--family);
	max-width: 60rem;
	padding-left: 2rem;
	padding-right: 2rem;
}

/*
yaml header settings
*/
#write pre.md-meta-block {
	font-family: var(--monospace-font);
	font-size: 1rem;
	text-align: left;
	padding: 0.6rem;
	color: rgb(134, 134, 134);
	background-color: var(--code-bg-color);
	border-radius: 0.4rem;
}

/*
headers settings
标题
*/
#write h1 {
	font-size: 1.75rem;
	text-align: center;
	font-family: var(--font--family-h1);
}

#write h2 {
	font-size: 1.5rem;
	border-bottom: 2px solid var(--color--h2--quote);
	font-family: var(--font--family-h2);
}

#write h2 span {
	display: inline-block;
	font-weight: bold;
	background: var(--color--h2--quote);
	color: #ffffff;
	padding: 3px 10px 1px;
	border-top-right-radius: 3px;
	border-top-left-radius: 3px;
	margin-right: 3px;
}

#write h2:after {
	display: inline-block;
	content: "";
	vertical-align: bottom;
	border-bottom: 36px solid #efebe9;
	border-right: 20px solid transparent;
}

h3 {
	font-size: 1.3em;
	line-height: 1.43;
	margin: 1.6em auto 1.2em;
	padding-left: 8px;
	border-left: 4px solid var(--color--h2--quote);
}

#write>h3.md-focus {
	border-color: var(--color--h--focus);
}

#write h4 {
	font-size: 1.15rem;
}

#write h5 {
	font-size: 1rem;
}

#write h6 {
	font-size: 1rem;
}

/* 标题点击后的前缀提示图标 */
#write>h3.md-focus:before {
	width: auto;
	height: auto;
	background-color: var(--color--h--focus);
	color: #ffffff;
}

#write>h4.md-focus:before {
	width: auto;
	height: auto;
	background-color: #ff5d52;
	color: #ffffff;
	margin-top: -1px;
}

#write h5.md-focus:before,
#write h6.md-focus:before {
	margin-top: 6px;
	color: #ff5d52;
	font-size: 0.4rem;
}

/*
tables settings
表格
*/
#write table {
	display: table;
	text-align: left;
}

#write tbody {
	border: 0;
}

#write table tr {
	border: 0;
	border-top: 1px solid #ccc;
	background-color: white;
}

#write table tr:nth-child(2n) {
	background-color: #F8F8F8;
}

#write table tr th,
#write table tr td {
	font-size: 16px;
	border: 1px solid #ccc;
	padding: 5px 10px;
	text-align: left;
}

#write table tr th {
	font-weight: bold;
	background-color: #f0f0f0;
}

/*
checkboxes settings
任务列表
*/
.md-task-list-item>input {
    margin-left: -1.3em;
    margin-top: 0.4rem;
    -webkit-appearance: none;
}

/* 任务列表未选中 */
#write .task-list-item input[type="checkbox"]::before,
#write input[type="checkbox"]:checked::before {
	content: "";
	display: inline-block;

	/*圆形框*/
	border-radius: 1.1rem;

	/* 方形框 */
	/* border-radius: 0.1rem; */
	vertical-align: middle;
	border: 1.2px solid #81accf;
	background-color: #ffffff;
	width: 1.1rem;
	height: 1.1rem;
	margin-left: -1px;
	margin-right: 0.1rem;
	margin-top: -0.19rem;
}

/* 任务列表选中 */
#write .task-list-item input[type="checkbox"]:checked::before {
	padding-left: 0.125em;
	padding-top: 0em;
	content: '✔';
	color: white;
	background-color: #81accf;
	font-size: 0.8rem;
	line-height: 0.95rem;
	margin-left: -1px;
	margin-right: 0.1rem;
	margin-top: -0.19rem;
	transition: background-color 200ms ease-in-out;
}

#write .task-list-item input[type="checkbox"]:checked+p {
	text-decoration: line-through;
	color: var(--del-color);
}

#write input[type='checkbox']:hover::before {
	transition: all 0.2s;
	background-color: rgb(228, 228, 228);
}

/** 有序、无序列表 **/
/* 有序列表在加入换行后重新计数了，故注释了，待修复 */
/* #write ol li,
#write .ol .li, */
#write ul li,
#write .ul .li {
	list-style-type: none;
}

#write ul>li:not(.tab):before,
#write .ul>.li:not(.tab):before {
	margin-left: -18px;
	margin-top: 7px;
	width: .62em;
	height: .62em;
	border: .1em solid var(--ulol-color);

	border-radius: .31em;
	background: 0 0;
	content: '';
	line-height: .42em;
}

/* #write ol li:before,
#write .ol .li:before, */
#write ul li:before,
#write .ul .li:before {
	position: absolute;
	background: var(--ulol-color);
	color: var(--olfore-color);
	cursor: pointer;
	-webkit-transition: all .3s ease-out;
	-moz-transition: all .3s ease-out;
	-o-transition: all .3s ease-out;
	-ms-transition: all .3s ease-out;
	transition: all .3s ease-out;
}

/* #write ol li:first-child,
#write .ol .li:first-child {
	counter-reset: li;
} */

/* #write ol>li:before,
#write .ol>.li:before {
	margin-top: 3.8px;
	margin-left: -21px;
	width: 1.65em;
	height: 1.65em;
	border-radius: 0.825em;
	content: counter(li);
	counter-increment: li;
	text-align: center;
	font-size: .65em;
	line-height: 1.7em;
} */

/* 列表子项上下间隔调整 */
/* #write ol li *,
#write .ol .li *  */
#write ul li *,
#write .ul .li * {
	margin-top: 0px;
	margin-bottom: 0px;
}

/* 列表上下间隔调整 */

/* #write ol li,
#write .ol .li, */
#write ul li,
#write .ul .li {
	margin-top: 7px;
	margin-bottom: 7px;
}


/*
blockquotes settings
引用
*/
#write blockquote {
	color: #7e7a7a;
	border-left: 0.25rem solid var(--color--h2--quote);
	background: var(--color--quote--backgroudn);
	padding: 0.25rem 0.5rem;
	border-radius: 0.25rem;
}

/* 引用中的彩虹 */
#write blockquote::before {
	display: block;
	height: 2rem;
	width: 1.5rem;
	content: "🌈";
	font-size: 1.2rem;
}

/* 引用内单行代码 */
#write blockquote code {
	background-color: transparent;
}

/*
horizontal rules settings
*/
#write hr {
	margin-top: 2rem;
	margin-bottom: 2rem;
	background-color: rgb(226, 226, 226);
	height: 0.13rem;
	border: 0;
}


/*
code blocks settings
代码块
*/
#write .md-fences {
	font-family: var(--monospace-font);
	font-size: 1rem;
	padding: 0.6rem;
	background-color: var(--code-bg-color);
	border-radius: 0.4rem;
	box-shadow: var(--block-shadow);
}

#write .cm-s-inner .CodeMirror-gutters {
	border: none;
}

#write .cm-s-inner .CodeMirror-linenumber {
	color: rgb(212, 212, 212);
}

#write .cm-s-inner .cm-keyword {
	color: rgb(204, 35, 35);
}

#write .cm-s-inner .cm-number {
	color: rgb(27, 57, 226);
}

#write .cm-s-inner .cm-def {
	color: rgb(146, 50, 255);
}

#write .cm-s-inner .cm-operator {
	color: rgb(204, 35, 35);
}

#write .cm-s-inner .cm-variable2 {
	color: rgb(38, 129, 219);
}

#write .cm-s-inner .cm-variable3 {
	color: rgb(204, 35, 35);
}

#write .cm-s-inner .cm-comment {
	color: rgb(18, 129, 18);
}

#write .cm-s-inner .cm-string {
	color: rgb(18, 129, 18);
}

#write .cm-s-inner .cm-builtin {
	color: rgb(218, 135, 12);
}

#write .cm-tag {
	color: rgb(139, 10, 10);
}

/*
formulas settings
*/
#write mjx-container {
	font-size: 1.1rem;
}

/*
tooltips settings
*/
#write .code-tooltip {
	box-shadow: 0.1rem 0.1rem 0.2rem rgb(150, 150, 150);
	border-radius: 0.2rem;
	margin-top: 0.3rem;
}

/*
selected texts in code blocks settings
*/
#write .CodeMirror-selected,
#write .CodeMirror-selectedtext,
#write .in-text-selection {
	background-color: var(--selection-bg-color) !important;
}
/*
selected texts settings
文本选中后的颜色
*/
#write ::selection {
	background-color: var(--selection-bg-color);
}

/*
diagrams settings
*/
#write pre[lang=’sequence’],
#write pre[lang=’flow’],
#write pre[lang=’mermaid’] {
	background-color: var(--code-bg-color);
	border-radius: 0.4rem;
	box-shadow: var(--block-shadow);
}

/*
inline codes settings
行内代码
*/
#write code {
	font-family: var(--monospace-font);
	padding: 0.05rem 0.12rem;
	color: var(--color--inlinecode--font);
	background-color: var(--color--inlinecode--background);
	border-radius: 0.4rem;
}

/*
urls settings
超链接
*/
#write a {
	color: var(--color--url);
	text-decoration: none;
}

#write a:hover {
	border-radius: 6px;
	border-bottom: 2px solid transparent;
	background-color: var(--color--url--focus);
	color: var(--color--url--focus--font) !important;
	cursor: pointer;
	padding: 2.5px 2.5px;
	font-size: 1rem;
}

/*
images settings
图像
*/
#write img {
	display: block;
	margin: 0 auto;
	border: 0;
	border-radius: 12px;
	box-shadow: var(--block-shadow);
	margin-bottom: 4px;
}

/*
deletes settings
删除线
*/
#write del {
	color: var(--del-color);
}


kbd {
	background-color: rgb(255, 255, 255);
	border-radius: 8px;
	color: black;
	padding: 1px 4px;
	font-family: "微软雅黑";
	font-size: 0.8rem;
	border-top: 1px solid #cfcfcf;
	border-left: 1px solid #cfcfcf;
	border-right: 1px solid #cfcfcf;
	border-bottom: 3px solid #cfcfcf;
}

/* 斜体 */
em {
	font-style: normal;
	color: var(--italic-color);
}

/* 粗体 */
strong {
	background-color: inherit;
	color: var(--strong-color);
}

/* 下划线 */
u {
	background-color: inherit;
	color: inherit;
	text-decoration: none;
	border-bottom: 2px solid var(--underline-color);
	padding-bottom: 1px;
}

/* 高亮 */
mark {
	color: black;
	font-weight: normal;
	padding: 1px 5px 2px;
	border-radius: 2px;
	background-color: var(--color--highlight) !important;
}

/* sidebar	侧边栏 */
#typora-sidebar {
	background-color: #f3f2ee;
	/* 分割线 */
	border-right: 1px dashed #C0C0C0;
}

#typora-sidebar #sidebar-loading-template.file-list-item {
	border-bottom: transparent !important;
	background-color: rgba(171, 192, 208, 0.1);
}

#typora-sidebar .info-panel-tab-wrapper .info-panel-tab:hover {
	color: inherit;
}

#typora-sidebar .info-panel-tab-wrapper .info-panel-tab .info-panel-tab-border {
	background-color: #2f845e;
	border-radius: 4px;
}

#typora-sidebar .sidebar-osx-tab .sidebar-tabs {
	border-bottom-color: transparent;
}

#typora-sidebar #sidebar-content .file-list-item {
	border-bottom: 1px solid #eee;
}

#typora-sidebar #sidebar-content .file-list-item.active {
	background-color: rgba(66, 185, 131, 0.1);
	border-left: 4px solid #2f845e;
}

#typora-sidebar #sidebar-content .ty-sidebar-search-panel {
	border-bottom: 1px solid #eee;
}

#typora-sidebar #sidebar-content .ty-sidebar-search-panel .searchpanel-search-option-btn {
	background-color: #fff;
}

#typora-sidebar #sidebar-content .sidebar-content-content .file-node-content {
	line-height: 1.375rem;
	font-size: 1rem;
	color: #282c34 !important;
}

#typora-sidebar #sidebar-content .sidebar-content-content .file-tree-node:not(.file-node-root):hover>.file-node-background {
	border-left: 4px solid #2f845e;
	background-color: rgba(66, 185, 131, 0.1);
}

#typora-sidebar #sidebar-content .sidebar-content-content .file-tree-node.active>.file-node-background {
	border-color: #2f845e;
	background-color: rgba(66, 185, 131, 0.1);
}

#typora-sidebar #sidebar-content .sidebar-content-content #file-library-list-children .file-library-file-node:hover {
	border-left: 4px solid #2f845e;
	background-color: rgba(66, 185, 131, 0.1);
}

#typora-sidebar #sidebar-content #outline-content .no-collapse-outline .outline-item {
	line-height: 1.375rem;
	font-size: 1rem;
}

#typora-sidebar #sidebar-content #outline-content .outline-expander:before {
	color: inherit;
	font-size: 14px;
	top: auto;
	content: "\f0da";
	font-family: FontAwesome;
}

#typora-sidebar #sidebar-content #outline-content .outline-expander:hover:before,
#typora-sidebar #sidebar-content #outline-content .outline-item-open>.outline-item>.outline-expander:before {
	content: "\f0d7";
}

#typora-sidebar #sidebar-content #outline-content .outline-item:hover {
	background-color: #bac6e9 !important;
}

#typora-sidebar #ty-sidebar-footer {
	border-top: 1px solid #eee;
}

#typora-sidebar #ty-sidebar-footer .sidebar-footer-item:hover {
	background-color: #bac6e9 !important;
}

#typora-sidebar #ty-sidebar-footer #sidebar-files-menu {
	-webkit-box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.16), 0 2px 10px 0 rgba(0, 0, 0, 0.12);
	box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.16), 0 2px 10px 0 rgba(0, 0, 0, 0.12);
}


/* mac 风格 */
#write pre.md-fences {
	padding: 1rem 0.5rem 1rem;
	display: block;
	-webkit-overflow-scrolling: touch;
	/* box-shadow: 0 0 6px 2px rgba(151, 151, 151, 0.9); */
	/* border-top: rgb(51, 51, 51) solid 24px; */
	border-top: rgb(244, 244, 244) solid 24px;
	background-color: rgb(244, 244, 244);
}

pre.md-fences::before {
	content: '';
	background: #fc625d;
	box-shadow: 23px 0 #fdbc40, 45px 0 #35cd4b;
	border-radius: 50%;
	margin-top: -1.73rem;
	position: absolute;
	left: 15px;
	height: 12px;
	width: 12px;
}


/** 图片 **/

/* 图片自动编号 */
#write {
    counter-reset: imgNum;
}

#write p>.md-image:after {
    counter-increment: imgNum;
    content: "图 " counter(imgNum) attr(alt) !important;
    text-align: center;
    width: 100%;
    display: inline-block;
    margin-top: 8px !important;
    font-size: small;
	font-family:"华康手札体W5P";
    font-size:1rem;
	color:gray;
}


</style><title>微服务保护</title>
</head>
<body class='typora-export os-windows typora-export-show-outline typora-export-collapse-outline'><div class='typora-export-content'>
<div class="typora-export-sidebar"><div class="outline-content"><li class="outline-item-wrapper outline-h1 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#微服务保护">微服务保护</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1初识sentinel">1.初识Sentinel</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#11雪崩问题及解决方案">1.1.雪崩问题及解决方案</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#111雪崩问题">1.1.1.雪崩问题</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#112超时处理">1.1.2.超时处理</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#113仓壁模式">1.1.3.仓壁模式</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#114断路器">1.1.4.断路器</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#115限流">1.1.5.限流</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#116总结">1.1.6.总结</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#12服务保护技术对比">1.2.服务保护技术对比</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#13sentinel介绍和安装">1.3.Sentinel介绍和安装</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#131初识sentinel">1.3.1.初识Sentinel</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#132安装sentinel">1.3.2.安装Sentinel</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#14微服务整合sentinel">1.4.微服务整合Sentinel</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2流量控制">2.流量控制</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#21簇点链路">2.1.簇点链路</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#21快速入门">2.1.快速入门</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#211示例">2.1.1.示例</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#212练习">2.1.2.练习：</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#22流控模式">2.2.流控模式</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#221关联模式">2.2.1.关联模式</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#222链路模式">2.2.2.链路模式</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1）添加查询商品方法">1）添加查询商品方法</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2）查询订单时查询商品">2）查询订单时，查询商品</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#3）新增订单查询商品">3）新增订单，查询商品</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#4）给查询商品添加资源标记">4）给查询商品添加资源标记</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#5）添加流控规则">5）添加流控规则</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#6）jmeter测试">6）Jmeter测试</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#223总结">2.2.3.总结</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#23流控效果">2.3.流控效果</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#231warm-up">2.3.1.warm up</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1）配置流控规则">1）配置流控规则：</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2）jmeter测试-1">2）Jmeter测试</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#232排队等待">2.3.2.排队等待</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1）添加流控规则">1）添加流控规则</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2）jmeter测试-2">2）Jmeter测试</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#233总结">2.3.3.总结</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#24热点参数限流">2.4.热点参数限流</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#241全局参数限流">2.4.1.全局参数限流</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#242热点参数限流">2.4.2.热点参数限流</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#244案例">2.4.4.案例</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1）标记资源">1）标记资源</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2）热点参数限流规则">2）热点参数限流规则</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#3）jmeter测试">3）Jmeter测试</a></div><ul class="outline-children"></ul></li></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#3隔离和降级">3.隔离和降级</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#31feignclient整合sentinel">3.1.FeignClient整合Sentinel</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#311修改配置开启sentinel功能">3.1.1.修改配置，开启sentinel功能</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#312编写失败降级逻辑">3.1.2.编写失败降级逻辑</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#313总结">3.1.3.总结</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#32线程隔离舱壁模式）">3.2.线程隔离（舱壁模式）</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#321线程隔离的实现方式">3.2.1.线程隔离的实现方式</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#322sentinel的线程隔离">3.2.2.sentinel的线程隔离</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1）配置隔离规则">1）配置隔离规则</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2）jmeter测试-3">2）Jmeter测试</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#323总结">3.2.3.总结</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#33熔断降级">3.3.熔断降级</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#331慢调用">3.3.1.慢调用</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1）设置慢调用">1）设置慢调用</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2）设置熔断规则-1">2）设置熔断规则</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#3）测试-1">3）测试</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#332异常比例异常数">3.3.2.异常比例、异常数</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#1）设置异常请求">1）设置异常请求</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#2）设置熔断规则-2">2）设置熔断规则</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#3）测试-2">3）测试</a></div><ul class="outline-children"></ul></li></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#4授权规则">4.授权规则</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#41授权规则">4.1.授权规则</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#411基本规则">4.1.1.基本规则</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#412如何获取origin">4.1.2.如何获取origin</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#413给网关添加请求头">4.1.3.给网关添加请求头</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#414配置授权规则">4.1.4.配置授权规则</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#42自定义异常结果">4.2.自定义异常结果</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#421异常类型">4.2.1.异常类型</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#422自定义异常处理">4.2.2.自定义异常处理</a></div><ul class="outline-children"></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#5规则持久化">5.规则持久化</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#51规则管理模式">5.1.规则管理模式</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#511pull模式">5.1.1.pull模式</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#512push模式">5.1.2.push模式</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2 outline-item-single"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#52实现push模式">5.2.实现push模式</a></div><ul class="outline-children"></ul></li></ul></li></div></div><div id='write'  class=''><h1 id='微服务保护'><span>微服务保护</span></h1><p>&nbsp;</p><p>&nbsp;</p><h1 id='1初识sentinel'><span>1.初识Sentinel</span></h1><p>&nbsp;</p><h2 id='11雪崩问题及解决方案'><span>1.1.雪崩问题及解决方案</span></h2><p>&nbsp;</p><h3 id='111雪崩问题'><span>1.1.1.雪崩问题</span></h3><p>&nbsp;</p><p><span>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。</span></p><p><span> </span><img src="assets/1533829099748.png" referrerpolicy="no-referrer" alt="1533829099748"></p><p>&nbsp;</p><p><span>如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务似乎不受影响。</span></p><p><span> </span><img src="assets/1533829198240.png" referrerpolicy="no-referrer" alt="1533829198240"></p><p><span>但是，依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：</span></p><p><span> </span><img src="assets/1533829307389.png" referrerpolicy="no-referrer" alt="1533829307389"></p><p><span>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。</span></p><p><span>那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就发生了：</span></p><p><img src="assets/image-20210715172710340.png" referrerpolicy="no-referrer" alt="image-20210715172710340"></p><p>&nbsp;</p><h3 id='112超时处理'><span>1.1.2.超时处理</span></h3><p><span>解决雪崩问题的常见方式有四种：</span></p><p><span>•超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待</span></p><p><img src="assets/image-20210715172820438.png" referrerpolicy="no-referrer" alt="image-20210715172820438"></p><p>&nbsp;</p><h3 id='113仓壁模式'><span>1.1.3.仓壁模式</span></h3><p><span>方案2：仓壁模式</span></p><p><span>仓壁模式来源于船舱的设计：</span></p><p><img src="assets/image-20210715172946352.png" referrerpolicy="no-referrer" alt="image-20210715172946352"></p><p><span>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。</span></p><p>&nbsp;</p><p><span>于此类似，我们可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。</span></p><p><img src="assets/image-20210715173215243.png" referrerpolicy="no-referrer" alt="image-20210715173215243"></p><p>&nbsp;</p><h3 id='114断路器'><span>1.1.4.断路器</span></h3><p><span>断路器模式：由</span><strong><span>断路器</span></strong><span>统计业务执行的异常比例，如果超出阈值则会</span><strong><span>熔断</span></strong><span>该业务，拦截访问该业务的一切请求。</span></p><p><span>断路器会统计访问某个服务的请求数量，异常比例：</span></p><p><img src="assets/image-20210715173327075.png" referrerpolicy="no-referrer" alt="image-20210715173327075"></p><p><span>当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：</span></p><p><img src="assets/image-20210715173428073.png" referrerpolicy="no-referrer" alt="image-20210715173428073"></p><p>&nbsp;</p><h3 id='115限流'><span>1.1.5.限流</span></h3><p><strong><span>流量控制</span></strong><span>：限制业务访问的QPS，避免服务因流量的突增而故障。</span></p><p><img src="assets/image-20210715173555158.png" referrerpolicy="no-referrer" alt="image-20210715173555158"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h3 id='116总结'><span>1.1.6.总结</span></h3><p><span>什么是雪崩问题？</span></p><ul><li><span>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</span></li></ul><p>&nbsp;</p><p><span>可以认为：</span></p><p><strong><span>限流</span></strong><span>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种</span><strong><span>预防</span></strong><span>措施。</span></p><p><strong><span>超时处理、线程隔离、降级熔断</span></strong><span>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种</span><strong><span>补救</span></strong><span>措施。</span></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='12服务保护技术对比'><span>1.2.服务保护技术对比</span></h2><p><span>在SpringCloud当中支持多种服务保护技术：</span></p><ul><li><a href='https://github.com/Netflix/Hystrix'><span>Netfix Hystrix</span></a></li><li><a href='https://github.com/alibaba/Sentinel'><span>Sentinel</span></a></li><li><a href='https://github.com/resilience4j/resilience4j'><span>Resilience4J</span></a></li></ul><p><span>早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，这里我们做下对比：</span></p><figure><table><thead><tr><th>&nbsp;</th><th><strong><span>Sentinel</span></strong></th><th><strong><span>Hystrix</span></strong></th></tr></thead><tbody><tr><td><span>隔离策略</span></td><td><span>信号量隔离</span></td><td><span>线程池隔离/信号量隔离</span></td></tr><tr><td><span>熔断降级策略</span></td><td><span>基于慢调用比例或异常比例</span></td><td><span>基于失败比率</span></td></tr><tr><td><span>实时指标实现</span></td><td><span>滑动窗口</span></td><td><span>滑动窗口（基于 RxJava）</span></td></tr><tr><td><span>规则配置</span></td><td><span>支持多种数据源</span></td><td><span>支持多种数据源</span></td></tr><tr><td><span>扩展性</span></td><td><span>多个扩展点</span></td><td><span>插件的形式</span></td></tr><tr><td><span>基于注解的支持</span></td><td><span>支持</span></td><td><span>支持</span></td></tr><tr><td><span>限流</span></td><td><span>基于 QPS，支持基于调用关系的限流</span></td><td><span>有限的支持</span></td></tr><tr><td><span>流量整形</span></td><td><span>支持慢启动、匀速排队模式</span></td><td><span>不支持</span></td></tr><tr><td><span>系统自适应保护</span></td><td><span>支持</span></td><td><span>不支持</span></td></tr><tr><td><span>控制台</span></td><td><span>开箱即用，可配置规则、查看秒级监控、机器发现等</span></td><td><span>不完善</span></td></tr><tr><td><span>常见框架的适配</span></td><td><span>Servlet、Spring Cloud、Dubbo、gRPC  等</span></td><td><span>Servlet、Spring Cloud Netflix</span></td></tr></tbody></table></figure><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='13sentinel介绍和安装'><span>1.3.Sentinel介绍和安装</span></h2><p>&nbsp;</p><h3 id='131初识sentinel'><span>1.3.1.初识Sentinel</span></h3><p><span>Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：</span><a href='https://sentinelguard.io/zh-cn/index.html' target='_blank' class='url'>https://sentinelguard.io/zh-cn/index.html</a></p><p><span>Sentinel 具有以下特征:</span></p><p><span>•</span><strong><span>丰富的应用场景</span></strong><span>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</span></p><p><span>•</span><strong><span>完备的实时监控</span></strong><span>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</span></p><p><span>•</span><strong><span>广泛的开源生态</span></strong><span>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</span></p><p><span>•</span><strong><span>完善的</span></strong><span> </span><strong><span>SPI</span></strong><span> </span><strong><span>扩展点</span></strong><span>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</span></p><p>&nbsp;</p><h3 id='132安装sentinel'><span>1.3.2.安装Sentinel</span></h3><p><span>1）下载</span></p><p><span>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在</span><a href='https://github.com/alibaba/Sentinel/releases'><span>GitHub</span></a><span>下载。</span></p><p><span>课前资料也提供了下载好的jar包：</span></p><p><img src="assets/image-20210715174252531.png" referrerpolicy="no-referrer" alt="image-20210715174252531"></p><p>&nbsp;</p><p><span>2）运行</span></p><p><span>将jar包放到任意非中文目录，执行命令：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sh"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sh"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">java <span class="cm-attribute">-jar</span> sentinel-dashboard-1.8.1.jar</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 26px;"></div><div class="CodeMirror-gutters" style="height: 26px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</span></p><figure><table><thead><tr><th><strong><span>配置项</span></strong></th><th><strong><span>默认值</span></strong></th><th><strong><span>说明</span></strong></th></tr></thead><tbody><tr><td><span>server.port</span></td><td><span>8080</span></td><td><span>服务端口</span></td></tr><tr><td><span>sentinel.dashboard.auth.username</span></td><td><span>sentinel</span></td><td><span>默认用户名</span></td></tr><tr><td><span>sentinel.dashboard.auth.password</span></td><td><span>sentinel</span></td><td><span>默认密码</span></td></tr></tbody></table></figure><p><span>例如，修改端口：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="sh"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sh"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.7998px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">java <span class="cm-attribute">-Dserver</span><span class="cm-def">.port</span><span class="cm-operator">=</span><span class="cm-number">8090</span> <span class="cm-attribute">-jar</span> sentinel-dashboard-1.8.1.jar</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 51px;"></div><div class="CodeMirror-gutters" style="height: 51px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p><p>&nbsp;</p><p><span>3）访问</span></p><p><span>访问</span><a href='http://localhost:8080' target='_blank' class='url'>http://localhost:8080</a><span>页面，就可以看到sentinel的控制台了：</span></p><p><img src="assets/image-20210715190827846.png" referrerpolicy="no-referrer" alt="image-20210715190827846"></p><p><span>需要输入账号和密码，默认都是：sentinel</span></p><p>&nbsp;</p><p><span>登录后，发现一片空白，什么都没有：</span></p><p><img src="assets/image-20210715191134448.png" referrerpolicy="no-referrer" alt="image-20210715191134448"></p><p><span>这是因为我们还没有与微服务整合。</span></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='14微服务整合sentinel'><span>1.4.微服务整合Sentinel</span></h2><p><span>我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：</span></p><p><span>1）引入sentinel依赖</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">&lt;!--sentinel--&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span>com.alibaba.cloud<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="height: 179px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p><p><span>2）配置控制台</span></p><p><span>修改application.yaml文件，添加下面内容：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="yaml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">server</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  port</span><span class="cm-meta">: </span><span class="cm-number">8088</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">spring</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cloud</span><span class="cm-meta">: </span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  sentinel</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  transport</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp; &nbsp;  dashboard</span><span class="cm-meta">: </span>localhost<span class="cm-meta">:</span><span class="cm-number">8080</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="height: 179px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p><p><span>3）访问order-service的任意端点</span></p><p><span>打开浏览器，访问</span><a href='http://localhost:8088/order/101' target='_blank' class='url'>http://localhost:8088/order/101</a><span>，这样才能触发sentinel的监控。</span></p><p><span>然后再访问sentinel的控制台，查看效果：</span></p><p><img src="assets/image-20210715191241799.png" referrerpolicy="no-referrer" alt="image-20210715191241799"></p><p>&nbsp;</p><p>&nbsp;</p><h1 id='2流量控制'><span>2.流量控制</span></h1><p><span>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</span></p><h2 id='21簇点链路'><span>2.1.簇点链路</span></h2><p><span>当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做</span><strong><span>簇点链路</span></strong><span>。簇点链路中被监控的每一个接口就是一个</span><strong><span>资源</span></strong><span>。</span></p><p><span>默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。</span></p><p>&nbsp;</p><p><span>例如，我们刚才访问的order-service中的OrderController中的端点：/order/{orderId}</span></p><p><img src="assets/image-20210715191757319.png" referrerpolicy="no-referrer" alt="image-20210715191757319"></p><p>&nbsp;</p><p><span>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：</span></p><ul><li><span>流控：流量控制</span></li><li><span>降级：降级熔断</span></li><li><span>热点：热点参数限流，是限流的一种</span></li><li><span>授权：请求的权限控制</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><h2 id='21快速入门'><span>2.1.快速入门</span></h2><p>&nbsp;</p><h3 id='211示例'><span>2.1.1.示例</span></h3><p><span>点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。</span></p><p><img src="assets/image-20210715191757319.png" referrerpolicy="no-referrer" alt="image-20210715191757319"></p><p><span>表单中可以填写限流规则，如下：</span></p><p><img src="assets/image-20210715192010657.png" referrerpolicy="no-referrer" alt="image-20210715192010657"></p><p><span>其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。</span></p><p>&nbsp;</p><h3 id='212练习'><span>2.1.2.练习：</span></h3><p><span>需求：给 /order/{orderId}这个资源设置流控规则，QPS不能超过 5，然后测试。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><span>1）首先在sentinel控制台添加限流规则</span></p><p><img src="assets/image-20210715192455429.png" referrerpolicy="no-referrer" alt="image-20210715192455429"></p><p><span>2）利用jmeter测试</span></p><p><span>如果没有用过jmeter，可以参考课前资料提供的文档《Jmeter快速入门.md》</span></p><p><span>课前资料提供了编写好的Jmeter测试样例：</span></p><p><img src="assets/image-20210715200431615.png" referrerpolicy="no-referrer" alt="image-20210715200431615"></p><p><span>打开jmeter，导入课前资料提供的测试样例：</span></p><p><img src="assets/image-20210715200537171.png" referrerpolicy="no-referrer" alt="image-20210715200537171"></p><p><span>选择：</span></p><p><img src="assets/image-20210715200635414.png" referrerpolicy="no-referrer" alt="image-20210715200635414"></p><p><span>20个用户，2秒内运行完，QPS是10，超过了5.</span></p><p><span>选中</span><code>流控入门，QPS&lt;5</code><span>右键运行：</span></p><p><img src="assets/image-20210715200804594.png" referrerpolicy="no-referrer" alt="image-20210715200804594"></p><p>&nbsp;</p><blockquote><p><span>注意，不要点击菜单中的执行按钮来运行。</span></p></blockquote><p>&nbsp;</p><p><span>结果：</span></p><p><img src="assets/image-20210715200853671.png" referrerpolicy="no-referrer" alt="image-20210715200853671"></p><p><span>可以看到，成功的请求每次只有5个</span></p><p>&nbsp;</p><p>&nbsp;</p><h2 id='22流控模式'><span>2.2.流控模式</span></h2><p><span>在添加限流规则时，点击高级选项，可以选择三种</span><strong><span>流控模式</span></strong><span>：</span></p><ul><li><span>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</span></li><li><span>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</span></li><li><span>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</span></li></ul><p><img src="assets/image-20210715201827886.png" referrerpolicy="no-referrer" alt="image-20210715201827886"></p><p>&nbsp;</p><p><span>快速入门测试的就是直接模式。</span></p><p>&nbsp;</p><h3 id='221关联模式'><span>2.2.1.关联模式</span></h3><p><strong><span>关联模式</span></strong><span>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</span></p><p><strong><span>配置规则</span></strong><span>：</span></p><p><img src="assets/image-20210715202540786.png" referrerpolicy="no-referrer" alt="image-20210715202540786"></p><p><strong><span>语法说明</span></strong><span>：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。</span></p><p>&nbsp;</p><p><strong><span>使用场景</span></strong><span>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</span></p><p>&nbsp;</p><p><strong><span>需求说明</span></strong><span>：</span></p><ul><li><span>在OrderController新建两个端点：/order/query和/order/update，无需实现业务</span></li><li><span>配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流</span></li></ul><p>&nbsp;</p><p><span>1）定义/order/query端点，模拟订单查询</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@GetMapping</span>(<span class="cm-string">"/query"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-def">queryOrder</span>() {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"查询订单成功"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 102px;"></div><div class="CodeMirror-gutters" style="height: 102px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>2）定义/order/update端点，模拟订单更新</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@GetMapping</span>(<span class="cm-string">"/update"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-def">updateOrder</span>() {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"更新订单成功"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 102px;"></div><div class="CodeMirror-gutters" style="height: 102px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p><span>重启服务，查看sentinel控制台的簇点链路：</span></p><p><img src="assets/image-20210716101805951.png" referrerpolicy="no-referrer" alt="image-20210716101805951"></p><p>&nbsp;</p><p><span>3）配置流控规则</span></p><p><span>对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：</span></p><p><img src="assets/image-20210716101934499.png" referrerpolicy="no-referrer" alt="image-20210716101934499"></p><p><span>在表单中填写流控规则：</span></p><p><img src="assets/image-20210716102103814.png" referrerpolicy="no-referrer" alt="image-20210716102103814"></p><p>&nbsp;</p><p><span>4）在Jmeter测试</span></p><p><span>选择《流控模式-关联》：</span></p><p><img src="assets/image-20210716102416266.png" referrerpolicy="no-referrer" alt="image-20210716102416266"></p><p><span>可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5</span></p><p><span>查看http请求：</span></p><p><img src="assets/image-20210716102532554.png" referrerpolicy="no-referrer" alt="image-20210716102532554"></p><p><span>请求的目标是/order/update，这样这个断点就会触发阈值。</span></p><p><span>但限流的目标是/order/query，我们在浏览器访问，可以发现：</span></p><p><img src="assets/image-20210716102636030.png" referrerpolicy="no-referrer" alt="image-20210716102636030"></p><p><span>确实被限流了。</span></p><p>&nbsp;</p><p><span>5）总结</span></p><p><img src="assets/image-20210716103143002.png" referrerpolicy="no-referrer" alt="image-20210716103143002"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='222链路模式'><span>2.2.2.链路模式</span></h3><p><strong><span>链路模式</span></strong><span>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</span></p><p><strong><span>配置示例</span></strong><span>：</span></p><p><span>例如有两条请求链路：</span></p><ul><li><span>/test1 --&gt; /common</span></li><li><span>/test2 --&gt; /common</span></li></ul><p><span>如果只希望统计从/test2进入到/common的请求，则可以这样配置：</span></p><p><img src="assets/image-20210716103536346.png" referrerpolicy="no-referrer" alt="image-20210716103536346"></p><p><strong><span>实战案例</span></strong></p><p><span>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</span></p><p><span>步骤：</span></p><ol start='' ><li><span>在OrderService中添加一个queryGoods方法，不用实现业务</span></li><li><span>在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法</span></li><li><span>在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法</span></li><li><span>给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2</span></li></ol><p>&nbsp;</p><p><span>实现：</span></p><h4 id='1）添加查询商品方法'><span>1）添加查询商品方法</span></h4><p><span>在order-service服务中，给OrderService类添加一个queryGoods方法：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">queryGoods</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">err</span>.<span class="cm-variable">println</span>(<span class="cm-string">"查询商品"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 77px;"></div><div class="CodeMirror-gutters" style="height: 77px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p><h4 id='2）查询订单时查询商品'><span>2）查询订单时，查询商品</span></h4><p><span>在order-service的OrderController中，修改/order/query端点的业务逻辑：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 30px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 26px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -26px; width: 26px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@GetMapping</span>(<span class="cm-string">"/query"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-def">queryOrder</span>() {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 查询商品</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">orderService</span>.<span class="cm-variable">queryGoods</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 查询订单</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"查询订单"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 19px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"查询订单成功"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -26px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 19px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 205px;"></div><div class="CodeMirror-gutters" style="height: 205px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 26px;"></div></div></div></div></pre><p>&nbsp;</p><h4 id='3）新增订单查询商品'><span>3）新增订单，查询商品</span></h4><p><span>在order-service的OrderController中，修改/order/save端点，模拟新增订单：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>8</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@GetMapping</span>(<span class="cm-string">"/save"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-def">saveOrder</span>() {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 查询商品</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">orderService</span>.<span class="cm-variable">queryGoods</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 查询订单</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">err</span>.<span class="cm-variable">println</span>(<span class="cm-string">"新增订单"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"新增订单成功"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="height: 230px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p>&nbsp;</p><h4 id='4）给查询商品添加资源标记'><span>4）给查询商品添加资源标记</span></h4><p><span>默认情况下，OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。</span></p><p><span>给OrderService的queryGoods方法添加@SentinelResource注解：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@SentinelResource</span>(<span class="cm-string">"goods"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">queryGoods</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">err</span>.<span class="cm-variable">println</span>(<span class="cm-string">"查询商品"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 128px;"></div><div class="CodeMirror-gutters" style="height: 128px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p>&nbsp;</p><p><span>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</span></p><p><span>我们需要关闭这种对SpringMVC的资源聚合，修改order-service服务的application.yml文件：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="yaml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">spring</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cloud</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  sentinel</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  web-context-unify</span><span class="cm-meta">: </span>false <span class="cm-comment"># 关闭context整合</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 128px;"></div><div class="CodeMirror-gutters" style="height: 128px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p><span>重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：</span></p><p><img src="assets/image-20210716105227163.png" referrerpolicy="no-referrer" alt="image-20210716105227163"></p><p>&nbsp;</p><h4 id='5）添加流控规则'><span>5）添加流控规则</span></h4><p><span>点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：</span></p><p><img src="assets/image-20210716105408723.png" referrerpolicy="no-referrer" alt="image-20210716105408723"></p><p>&nbsp;</p><p><span>只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。</span></p><p>&nbsp;</p><h4 id='6）jmeter测试'><span>6）Jmeter测试</span></h4><p><span>选择《流控模式-链路》：</span></p><p><img src="assets/image-20210716105612312.png" referrerpolicy="no-referrer" alt="image-20210716105612312"></p><p><span>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2</span></p><p><span>一个http请求是访问/order/save：</span></p><p><img src="assets/image-20210716105812789.png" referrerpolicy="no-referrer" alt="image-20210716105812789"></p><p><span>运行的结果：</span></p><p><img src="assets/image-20210716110027064.png" referrerpolicy="no-referrer" alt="image-20210716110027064"></p><p><span>完全不受影响。</span></p><p>&nbsp;</p><p><span>另一个是访问/order/query：</span></p><p><img src="assets/image-20210716105855951.png" referrerpolicy="no-referrer" alt="image-20210716105855951"></p><p><span>运行结果：</span></p><p><img src="assets/image-20210716105956401.png" referrerpolicy="no-referrer" alt="image-20210716105956401"></p><p><span>每次只有2个通过。</span></p><p>&nbsp;</p><h3 id='223总结'><span>2.2.3.总结</span></h3><p><span>流控模式有哪些？</span></p><p><span>•直接：对当前资源限流</span></p><p><span>•关联：高优先级资源触发阈值，对低优先级资源限流。</span></p><p><span>•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流</span></p><p>&nbsp;</p><h2 id='23流控效果'><span>2.3.流控效果</span></h2><p><span>在流控的高级选项中，还有一个流控效果选项：</span></p><p><img src="assets/image-20210716110225104.png" referrerpolicy="no-referrer" alt="image-20210716110225104"></p><p><span>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</span></p><ul><li><span>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</span></li><li><span>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</span></li><li><span>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</span></li></ul><p>&nbsp;</p><h3 id='231warm-up'><span>2.3.1.warm up</span></h3><p><span>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（</span><strong><span>冷启动</span></strong><span>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</span></p><p>&nbsp;</p><p><span>warm up也叫</span><strong><span>预热模式</span></strong><span>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.</span></p><p><span>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.</span></p><p><img src="assets/image-20210716110629796.png" referrerpolicy="no-referrer" alt="image-20210716110629796"></p><p>&nbsp;</p><p><strong><span>案例</span></strong></p><p><span>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒</span></p><p>&nbsp;</p><h4 id='1）配置流控规则'><span>1）配置流控规则：</span></h4><p><img src="assets/image-20210716111012387.png" referrerpolicy="no-referrer" alt="image-20210716111012387"></p><p>&nbsp;</p><h4 id='2）jmeter测试-1'><span>2）Jmeter测试</span></h4><p><span>选择《流控效果，warm up》：</span></p><p><img src="assets/image-20210716111136699.png" referrerpolicy="no-referrer" alt="image-20210716111136699"></p><p><span>QPS为10.</span></p><p><span>刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：</span></p><p><img src="assets/image-20210716111303701.png" referrerpolicy="no-referrer" alt="image-20210716111303701"></p><p><span>随着时间推移，成功比例越来越高：</span></p><p><img src="assets/image-20210716111404717.png" referrerpolicy="no-referrer" alt="image-20210716111404717"></p><p>&nbsp;</p><p><span>到Sentinel控制台查看实时监控：</span></p><p><img src="assets/image-20210716111526480.png" referrerpolicy="no-referrer" alt="image-20210716111526480"></p><p><span>一段时间后：</span></p><p><img src="assets/image-20210716111658541.png" referrerpolicy="no-referrer" alt="image-20210716111658541"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='232排队等待'><span>2.3.2.排队等待</span></h3><p><span>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。</span></p><p><span>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</span></p><p><span>工作原理</span></p><p><span>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着</span><strong><span>预期等待时长</span></strong><span>超过2000ms的请求会被拒绝并抛出异常。</span></p><p><span>那什么叫做预期等待时长呢？</span></p><p><span>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</span></p><ul><li><span>第6个请求的</span><strong><span>预期等待时长</span></strong><span> =  200 * （6 - 1） = 1000ms</span></li><li><span>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</span></li></ul><p>&nbsp;</p><p><span>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</span></p><p><img src="assets/image-20210716113147176.png" referrerpolicy="no-referrer" alt="image-20210716113147176"></p><p><span>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</span></p><p><img src="assets/image-20210716113426524.png" referrerpolicy="no-referrer" alt="image-20210716113426524"></p><p>&nbsp;</p><p><span>平滑的QPS曲线，对于服务器来说是更友好的。</span></p><p>&nbsp;</p><p><strong><span>案例</span></strong></p><p><span>需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s</span></p><p>&nbsp;</p><h4 id='1）添加流控规则'><span>1）添加流控规则</span></h4><p><img src="assets/image-20210716114048918.png" referrerpolicy="no-referrer" alt="image-20210716114048918"></p><p>&nbsp;</p><h4 id='2）jmeter测试-2'><span>2）Jmeter测试</span></h4><p><span>选择《流控效果，队列》：</span></p><p><img src="assets/image-20210716114243558.png" referrerpolicy="no-referrer" alt="image-20210716114243558"></p><p><span>QPS为15，已经超过了我们设定的10。</span></p><p><span>如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。</span></p><p><span>但是我们看看队列模式的运行结果：</span></p><p><img src="assets/image-20210716114429361.png" referrerpolicy="no-referrer" alt="image-20210716114429361"></p><p><span>全部都通过了。</span></p><p><span>再去sentinel查看实时监控的QPS曲线：</span></p><p><img src="assets/image-20210716114522935.png" referrerpolicy="no-referrer" alt="image-20210716114522935"></p><p><span>QPS非常平滑，一致保持在10，但是超出的请求没有被拒绝，而是放入队列。因此</span><strong><span>响应时间</span></strong><span>（等待时间）会越来越长。</span></p><p><span>当队列满了以后，才会有部分请求失败：</span></p><p><img src="assets/image-20210716114651137.png" referrerpolicy="no-referrer" alt="image-20210716114651137"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='233总结'><span>2.3.3.总结</span></h3><p><span>流控效果有哪些？</span></p><ul><li><span>快速失败：QPS超过阈值时，拒绝新的请求</span></li><li><span>warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。</span></li><li><span>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><h2 id='24热点参数限流'><span>2.4.热点参数限流</span></h2><p><span>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是</span><strong><span>分别统计参数值相同的请求</span></strong><span>，判断是否超过QPS阈值。</span></p><h3 id='241全局参数限流'><span>2.4.1.全局参数限流</span></h3><p><span>例如，一个根据id查询商品的接口：</span></p><p><img src="assets/image-20210716115014663.png" referrerpolicy="no-referrer" alt="image-20210716115014663"></p><p><span>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</span></p><p><img src="assets/image-20210716115131463.png" referrerpolicy="no-referrer" alt="image-20210716115131463"></p><p><span>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</span></p><p>&nbsp;</p><p><span>配置示例：</span></p><p><img src="assets/image-20210716115232426.png" referrerpolicy="no-referrer" alt="image-20210716115232426"></p><p><span>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒</span><strong><span>相同参数值</span></strong><span>的请求数不能超过5</span></p><p>&nbsp;</p><h3 id='242热点参数限流'><span>2.4.2.热点参数限流</span></h3><p><span>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.</span></p><p><span>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</span></p><p><img src="assets/image-20210716115717523.png" referrerpolicy="no-referrer" alt="image-20210716115717523"></p><p><span>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：</span></p><p><span>•如果参数值是100，则每1秒允许的QPS为10</span></p><p><span>•如果参数值是101，则每1秒允许的QPS为15</span></p><p>&nbsp;</p><h3 id='244案例'><span>2.4.4.案例</span></h3><p><strong><span>案例需求</span></strong><span>：给/order/{orderId}这个资源添加热点参数限流，规则如下：</span></p><p><span>•默认的热点参数规则是每1秒请求量不超过2</span></p><p><span>•给102这个参数设置例外：每1秒请求量不超过4</span></p><p><span>•给103这个参数设置例外：每1秒请求量不超过10</span></p><p>&nbsp;</p><p><strong><span>注意事项</span></strong><span>：热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源</span></p><p>&nbsp;</p><h4 id='1）标记资源'><span>1）标记资源</span></h4><p><span>给order-service中的OrderController中的/order/{orderId}资源添加注解：</span></p><p><img src="assets/image-20210716120033572.png" referrerpolicy="no-referrer" alt="image-20210716120033572"></p><p>&nbsp;</p><h4 id='2）热点参数限流规则'><span>2）热点参数限流规则</span></h4><p><span>访问该接口，可以看到我们标记的hot资源出现了：</span></p><p><img src="assets/image-20210716120208509.png" referrerpolicy="no-referrer" alt="image-20210716120208509"></p><p><span>这里不要点击hot后面的按钮，页面有BUG</span></p><p>&nbsp;</p><p><span>点击左侧菜单中</span><strong><span>热点规则</span></strong><span>菜单：</span></p><p><img src="assets/image-20210716120319009.png" referrerpolicy="no-referrer" alt="image-20210716120319009"></p><p><span>点击新增，填写表单：</span></p><p><img src="assets/image-20210716120536714.png" referrerpolicy="no-referrer" alt="image-20210716120536714"></p><p>&nbsp;</p><h4 id='3）jmeter测试'><span>3）Jmeter测试</span></h4><p><span>选择《热点参数限流 QPS1》：</span></p><p><img src="assets/image-20210716120754527.png" referrerpolicy="no-referrer" alt="image-20210716120754527"></p><p><span>这里发起请求的QPS为5.</span></p><p><span>包含3个http请求：</span></p><p><span>普通参数，QPS阈值为2</span></p><p><img src="assets/image-20210716120840501.png" referrerpolicy="no-referrer" alt="image-20210716120840501"></p><p><span>运行结果：</span></p><p><img src="assets/image-20210716121105567.png" referrerpolicy="no-referrer" alt="image-20210716121105567"></p><p>&nbsp;</p><p><span>例外项，QPS阈值为4</span></p><p><img src="assets/image-20210716120900365.png" referrerpolicy="no-referrer" alt="image-20210716120900365"></p><p><span>运行结果：</span></p><p><img src="assets/image-20210716121201630.png" referrerpolicy="no-referrer" alt="image-20210716121201630"></p><p>&nbsp;</p><p><span>例外项，QPS阈值为10</span></p><p><img src="assets/image-20210716120919131.png" referrerpolicy="no-referrer" alt="image-20210716120919131"></p><p><span>运行结果：</span></p><p><img src="assets/image-20210716121220305.png" referrerpolicy="no-referrer" alt="image-20210716121220305"></p><p>&nbsp;</p><h1 id='3隔离和降级'><span>3.隔离和降级</span></h1><p><span>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。</span></p><p><span>而要将这些故障控制在一定范围，避免雪崩，就要靠</span><strong><span>线程隔离</span></strong><span>（舱壁模式）和</span><strong><span>熔断降级</span></strong><span>手段了。</span></p><p>&nbsp;</p><p><strong><span>线程隔离</span></strong><span>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</span></p><p><img src="assets/image-20210715173215243.png" referrerpolicy="no-referrer" alt="image-20210715173215243"></p><p>&nbsp;</p><p><strong><span>熔断降级</span></strong><span>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</span></p><p><img src="assets/image-20210715173428073.png" referrerpolicy="no-referrer" alt="image-20210715173428073"></p><p>&nbsp;</p><p>&nbsp;</p><p><span>可以看到，不管是线程隔离还是熔断降级，都是对</span><strong><span>客户端</span></strong><span>（调用方）的保护。需要在</span><strong><span>调用方</span></strong><span> 发起远程调用时做线程隔离、或者服务熔断。</span></p><p><span>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。</span></p><p>&nbsp;</p><h2 id='31feignclient整合sentinel'><span>3.1.FeignClient整合Sentinel</span></h2><p><span>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</span></p><p>&nbsp;</p><h3 id='311修改配置开启sentinel功能'><span>3.1.1.修改配置，开启sentinel功能</span></h3><p><span>修改OrderService的application.yml文件，开启Feign的Sentinel功能：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="yaml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>3</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">feign</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  sentinel</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  enabled</span><span class="cm-meta">: </span>true <span class="cm-comment"># 开启feign对sentinel的支持</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 102px;"></div><div class="CodeMirror-gutters" style="height: 102px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p>&nbsp;</p><h3 id='312编写失败降级逻辑'><span>3.1.2.编写失败降级逻辑</span></h3><p><span>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</span></p><p><span>给FeignClient编写失败后的降级逻辑</span></p><p><span>①方式一：FallbackClass，无法对远程调用的异常做处理</span></p><p><span>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</span></p><p>&nbsp;</p><p><span>这里我们演示方式二的失败降级处理。</span></p><p><strong><span>步骤一</span></strong><span>：在feing-api项目中定义类，实现FallbackFactory：</span></p><p><img src="assets/image-20210716122403502.png" referrerpolicy="no-referrer" alt="image-20210716122403502"></p><p><span>代码：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.7998px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 40px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -40px; width: 40px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">package</span> <span class="cm-def">cn</span>.<span class="cm-variable">itcast</span>.<span class="cm-variable">feign</span>.<span class="cm-variable">clients</span>.<span class="cm-variable">fallback</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span class="cm-variable">itcast</span>.<span class="cm-variable">feign</span>.<span class="cm-variable">clients</span>.<span class="cm-variable">UserClient</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span class="cm-variable">itcast</span>.<span class="cm-variable">feign</span>.<span class="cm-variable">pojo</span>.<span class="cm-variable">User</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">feign</span>.<span class="cm-variable">hystrix</span>.<span class="cm-variable">FallbackFactory</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">lombok</span>.<span class="cm-variable">extern</span>.<span class="cm-variable">slf4j</span>.<span class="cm-variable">Slf4j</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Slf4j</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UserClientFallbackFactory</span> <span class="cm-keyword">implements</span> <span class="cm-variable">FallbackFactory</span><span class="cm-operator">&lt;</span><span class="cm-variable">UserClient</span><span class="cm-operator">&gt;</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">UserClient</span> <span class="cm-variable">create</span>(<span class="cm-variable">Throwable</span> <span class="cm-variable">throwable</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">UserClient</span>() {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">User</span> <span class="cm-variable">findById</span>(<span class="cm-variable-3">Long</span> <span class="cm-variable">id</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">log</span>.<span class="cm-variable">error</span>(<span class="cm-string">"查询用户异常"</span>, <span class="cm-variable">throwable</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">User</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  };</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 922px;"></div><div class="CodeMirror-gutters" style="height: 922px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 40px;"></div></div></div></div></pre><p>&nbsp;</p><p><strong><span>步骤二</span></strong><span>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Bean</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">UserClientFallbackFactory</span> <span class="cm-def">userClientFallbackFactory</span>(){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">UserClientFallbackFactory</span>();</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="height: 179px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p><strong><span>步骤三</span></strong><span>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.7998px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 40px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>12</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -40px; width: 40px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span class="cm-variable">itcast</span>.<span class="cm-variable">feign</span>.<span class="cm-variable">clients</span>.<span class="cm-variable">fallback</span>.<span class="cm-variable">UserClientFallbackFactory</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">cn</span>.<span class="cm-variable">itcast</span>.<span class="cm-variable">feign</span>.<span class="cm-variable">pojo</span>.<span class="cm-variable">User</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">cloud</span>.<span class="cm-variable">openfeign</span>.<span class="cm-variable">FeignClient</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">web</span>.<span class="cm-variable">bind</span>.<span class="cm-variable">annotation</span>.<span class="cm-variable">GetMapping</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">web</span>.<span class="cm-variable">bind</span>.<span class="cm-variable">annotation</span>.<span class="cm-variable">PathVariable</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@FeignClient</span>(<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"userservice"</span>, <span class="cm-variable">fallbackFactory</span> <span class="cm-operator">=</span> <span class="cm-variable">UserClientFallbackFactory</span>.<span class="cm-keyword">class</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">UserClient</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@GetMapping</span>(<span class="cm-string">"/user/{id}"</span>)</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">User</span> <span class="cm-variable">findById</span>(<span class="cm-meta">@PathVariable</span>(<span class="cm-string">"id"</span>) <span class="cm-variable-3">Long</span> <span class="cm-variable">id</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 691px;"></div><div class="CodeMirror-gutters" style="height: 691px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 40px;"></div></div></div></div></pre><p>&nbsp;</p><p><span>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：</span></p><p><img src="assets/image-20210716123705780.png" referrerpolicy="no-referrer" alt="image-20210716123705780"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='313总结'><span>3.1.3.总结</span></h3><p><span>Sentinel支持的雪崩解决方案：</span></p><ul><li><span>线程隔离（仓壁模式）</span></li><li><span>降级熔断</span></li></ul><p><span>Feign整合Sentinel的步骤：</span></p><ul><li><span>在application.yml中配置：feign.sentienl.enable=true</span></li><li><span>给FeignClient编写FallbackFactory并注册为Bean</span></li><li><span>将FallbackFactory配置到FeignClient</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='32线程隔离舱壁模式）'><span>3.2.线程隔离（舱壁模式）</span></h2><p>&nbsp;</p><h3 id='321线程隔离的实现方式'><span>3.2.1.线程隔离的实现方式</span></h3><p><span>线程隔离有两种方式实现：</span></p><ul><li><span>线程池隔离</span></li><li><span>信号量隔离（Sentinel默认采用）</span></li></ul><p><span>如图：</span></p><p><img src="assets/image-20210716123036937.png" referrerpolicy="no-referrer" alt="image-20210716123036937"></p><p>&nbsp;</p><p><strong><span>线程池隔离</span></strong><span>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</span></p><p><strong><span>信号量隔离</span></strong><span>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</span></p><p>&nbsp;</p><p><span>两者的优缺点：</span></p><p><img src="assets/image-20210716123240518.png" referrerpolicy="no-referrer" alt="image-20210716123240518"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='322sentinel的线程隔离'><span>3.2.2.sentinel的线程隔离</span></h3><p><strong><span>用法说明</span></strong><span>：</span></p><p><span>在添加限流规则时，可以选择两种阈值类型：</span></p><p><img src="assets/image-20210716123411217.png" referrerpolicy="no-referrer" alt="image-20210716123411217"></p><ul><li><span>QPS：就是每秒的请求数，在快速入门中已经演示过</span></li><li><span>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现</span><strong><span>线程隔离</span></strong><span>（舱壁模式）。</span></li></ul><p>&nbsp;</p><p><strong><span>案例需求</span></strong><span>：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。</span></p><p>&nbsp;</p><h4 id='1）配置隔离规则'><span>1）配置隔离规则</span></h4><p><span>选择feign接口后面的流控按钮：</span></p><p><img src="assets/image-20210716123831992.png" referrerpolicy="no-referrer" alt="image-20210716123831992"></p><p><span>填写表单：</span></p><p><img src="assets/image-20210716123936844.png" referrerpolicy="no-referrer" alt="image-20210716123936844"></p><p>&nbsp;</p><h4 id='2）jmeter测试-3'><span>2）Jmeter测试</span></h4><p><span>选择《阈值类型-线程数&lt;2》：</span></p><p><img src="assets/image-20210716124229894.png" referrerpolicy="no-referrer" alt="image-20210716124229894"></p><p><span>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。</span></p><p>&nbsp;</p><p><span>查看运行结果：</span></p><p><img src="assets/image-20210716124147820.png" referrerpolicy="no-referrer" alt="image-20210716124147820"></p><p><span>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。</span></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='323总结'><span>3.2.3.总结</span></h3><p><span>线程隔离的两种手段是？</span></p><ul><li><span>信号量隔离</span></li><li><span>线程池隔离</span></li></ul><p><span>信号量隔离的特点是？</span></p><ul><li><span>基于计数器模式，简单，开销小</span></li></ul><p><span>线程池隔离的特点是？</span></p><ul><li><span>基于线程池模式，有额外开销，但隔离控制更强</span></li></ul><p>&nbsp;</p><p>&nbsp;</p><h2 id='33熔断降级'><span>3.3.熔断降级</span></h2><p><span>熔断降级是解决雪崩问题的重要手段。其思路是由</span><strong><span>断路器</span></strong><span>统计服务调用的异常比例、慢请求比例，如果超出阈值则会</span><strong><span>熔断</span></strong><span>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</span></p><p><span>断路器控制熔断和放行是通过状态机来完成的：</span></p><p><img src="assets/image-20210716130958518.png" referrerpolicy="no-referrer" alt="image-20210716130958518"></p><p><span>状态机包括三个状态：</span></p><ul><li><p><span>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</span></p></li><li><p><span>open：打开状态，服务调用被</span><strong><span>熔断</span></strong><span>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</span></p></li><li><p><span>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。</span></p><ul><li><span>请求成功：则切换到closed状态</span></li><li><span>请求失败：则切换到open状态</span></li></ul></li></ul><p>&nbsp;</p><p><span>断路器熔断策略有三种：慢调用、异常比例、异常数</span></p><p>&nbsp;</p><h3 id='331慢调用'><span>3.3.1.慢调用</span></h3><p><strong><span>慢调用</span></strong><span>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</span></p><p><span>例如：</span></p><p><img src="assets/image-20210716145934347.png" referrerpolicy="no-referrer" alt="image-20210716145934347"></p><p><span>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</span></p><p>&nbsp;</p><p><strong><span>案例</span></strong></p><p><span>需求：给 UserClient的查询用户接口设置降级规则，慢调用的RT阈值为50ms，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5</span></p><p>&nbsp;</p><h4 id='1）设置慢调用'><span>1）设置慢调用</span></h4><p><span>修改user-service中的/user/{id}这个接口的业务。通过休眠模拟一个延迟时间：</span></p><p><img src="assets/image-20210716150234787.png" referrerpolicy="no-referrer" alt="image-20210716150234787"></p><p>&nbsp;</p><p><span>此时，orderId=101的订单，关联的是id为1的用户，调用时长为60ms：</span></p><p><img src="assets/image-20210716150510956.png" referrerpolicy="no-referrer" alt="image-20210716150510956"></p><p><span>orderId=102的订单，关联的是id为2的用户，调用时长为非常短；</span></p><p><img src="assets/image-20210716150605208.png" referrerpolicy="no-referrer" alt="image-20210716150605208"></p><p>&nbsp;</p><h4 id='2）设置熔断规则-1'><span>2）设置熔断规则</span></h4><p><span>下面，给feign接口设置降级规则：</span></p><p><img src="assets/image-20210716150654094.png" referrerpolicy="no-referrer" alt="image-20210716150654094"></p><p><span>规则：</span></p><p><img src="assets/image-20210716150740434.png" referrerpolicy="no-referrer" alt="image-20210716150740434"></p><p><span>超过50ms的请求都会被认为是慢请求</span></p><p>&nbsp;</p><h4 id='3）测试-1'><span>3）测试</span></h4><p><span>在浏览器访问：</span><a href='http://localhost:8088/order/101' target='_blank' class='url'>http://localhost:8088/order/101</a><span>，快速刷新5次，可以发现：</span></p><p><img src="assets/image-20210716150911004.png" referrerpolicy="no-referrer" alt="image-20210716150911004"></p><p><span>触发了熔断，请求时长缩短至5ms，快速失败了，并且走降级逻辑，返回的null</span></p><p>&nbsp;</p><p><span>在浏览器访问：</span><a href='http://localhost:8088/order/102' target='_blank' class='url'>http://localhost:8088/order/102</a><span>，竟然也被熔断了：</span></p><p><img src="assets/image-20210716151107785.png" referrerpolicy="no-referrer" alt="image-20210716151107785"></p><p>&nbsp;</p><p>&nbsp;</p><h3 id='332异常比例异常数'><span>3.3.2.异常比例、异常数</span></h3><p><strong><span>异常比例或异常数</span></strong><span>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</span></p><p><span>例如，一个异常比例设置：</span></p><p><img src="assets/image-20210716131430682.png" referrerpolicy="no-referrer" alt="image-20210716131430682"></p><p><span>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</span></p><p><span>一个异常数设置：</span></p><p><img src="assets/image-20210716131522912.png" referrerpolicy="no-referrer" alt="image-20210716131522912"></p><p><span>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。</span></p><p>&nbsp;</p><p><strong><span>案例</span></strong></p><p><span>需求：给 UserClient的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s</span></p><p>&nbsp;</p><h4 id='1）设置异常请求'><span>1）设置异常请求</span></h4><p><span>首先，修改user-service中的/user/{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：</span></p><p><img src="assets/image-20210716151348183.png" referrerpolicy="no-referrer" alt="image-20210716151348183"></p><p><span>也就是说，id 为 2时，就会触发异常</span></p><p>&nbsp;</p><h4 id='2）设置熔断规则-2'><span>2）设置熔断规则</span></h4><p><span>下面，给feign接口设置降级规则：</span></p><p><img src="assets/image-20210716150654094.png" referrerpolicy="no-referrer" alt="image-20210716150654094"></p><p><span>规则：</span></p><p><img src="assets/image-20210716151538785.png" referrerpolicy="no-referrer" alt="image-20210716151538785"></p><p><span>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断。</span></p><p>&nbsp;</p><h4 id='3）测试-2'><span>3）测试</span></h4><p><span>在浏览器快速访问：</span><a href='http://localhost:8088/order/102' target='_blank' class='url'>http://localhost:8088/order/102</a><span>，快速刷新5次，触发熔断：</span></p><p><img src="assets/image-20210716151722916.png" referrerpolicy="no-referrer" alt="image-20210716151722916"></p><p>&nbsp;</p><p><span>此时，我们去访问本来应该正常的103：</span></p><p><img src="assets/image-20210716151844817.png" referrerpolicy="no-referrer" alt="image-20210716151844817"></p><p>&nbsp;</p><p>&nbsp;</p><h1 id='4授权规则'><span>4.授权规则</span></h1><p><span>授权规则可以对请求方来源做判断和控制。</span></p><h2 id='41授权规则'><span>4.1.授权规则</span></h2><h3 id='411基本规则'><span>4.1.1.基本规则</span></h3><p><span>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</span></p><ul><li><span>白名单：来源（origin）在白名单内的调用者允许访问</span></li><li><span>黑名单：来源（origin）在黑名单内的调用者不允许访问</span></li></ul><p><span>点击左侧菜单的授权，可以看到授权规则：</span></p><p><img src="assets/image-20210716152010750.png" referrerpolicy="no-referrer" alt="image-20210716152010750"></p><ul><li><p><span>资源名：就是受保护的资源，例如/order/{orderId}</span></p></li><li><p><span>流控应用：是来源者的名单，</span></p><ul><li><span>如果是勾选白名单，则名单中的来源被许可访问。</span></li><li><span>如果是勾选黑名单，则名单中的来源被禁止访问。</span></li></ul></li></ul><p><span>比如：</span></p><p><img src="assets/image-20210716152349191.png" referrerpolicy="no-referrer" alt="image-20210716152349191"></p><p><span>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写</span><strong><span>网关的来源名称（origin）</span></strong><span>。</span></p><h3 id='412如何获取origin'><span>4.1.2.如何获取origin</span></h3><p><span>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.7998px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">RequestOriginParser</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 从请求request对象中获取origin，获取方式自定义</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">parseOrigin</span>(<span class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 256px;"></div><div class="CodeMirror-gutters" style="height: 256px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p><span>这个方法的作用就是从request对象中，获取请求者的origin值并返回。</span></p><p><span>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。</span></p><p>&nbsp;</p><p><span>因此，我们需要自定义这个接口的实现，让</span><strong><span>不同的请求，返回不同的origin</span></strong><span>。</span></p><p>&nbsp;</p><p><span>例如order-service服务中，我们定义一个RequestOriginParser的实现类：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.7998px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 40px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>21</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -40px; width: 40px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">package</span> <span class="cm-def">cn</span>.<span class="cm-variable">itcast</span>.<span class="cm-variable">order</span>.<span class="cm-variable">sentinel</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">alibaba</span>.<span class="cm-variable">csp</span>.<span class="cm-variable">sentinel</span>.<span class="cm-variable">adapter</span>.<span class="cm-variable">spring</span>.<span class="cm-variable">webmvc</span>.<span class="cm-variable">callback</span>.<span class="cm-variable">RequestOriginParser</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">stereotype</span>.<span class="cm-variable">Component</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">util</span>.<span class="cm-variable">StringUtils</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">servlet</span>.<span class="cm-variable">http</span>.<span class="cm-variable">HttpServletRequest</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Component</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">HeaderOriginParser</span> <span class="cm-keyword">implements</span> <span class="cm-variable">RequestOriginParser</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">parseOrigin</span>(<span class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 1.获取请求头</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">origin</span> <span class="cm-operator">=</span> <span class="cm-variable">request</span>.<span class="cm-variable">getHeader</span>(<span class="cm-string">"origin"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 2.非空判断</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">StringUtils</span>.<span class="cm-variable">isEmpty</span>(<span class="cm-variable">origin</span>)) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">origin</span> <span class="cm-operator">=</span> <span class="cm-string">"blank"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">origin</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 973px;"></div><div class="CodeMirror-gutters" style="height: 973px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 40px;"></div></div></div></div></pre><p><span>我们会尝试从request-header中获取origin值。</span></p><p>&nbsp;</p><h3 id='413给网关添加请求头'><span>4.1.3.给网关添加请求头</span></h3><p><span>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让</span><strong><span>所有从gateway路由到微服务的请求都带上origin头</span></strong><span>。</span></p><p><span>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。</span></p><p><span>修改gateway服务中的application.yml，添加一个defaultFilter：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="yaml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.8px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">spring</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cloud</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  gateway</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  default-filters</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp; &nbsp;  - </span>AddRequestHeader=origin,gateway</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  routes</span><span class="cm-meta">:</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment"># ...略</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 205px;"></div><div class="CodeMirror-gutters" style="height: 205px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p><span>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。</span></p><p>&nbsp;</p><h3 id='414配置授权规则'><span>4.1.4.配置授权规则</span></h3><p><span>接下来，我们添加一个授权规则，放行origin值为gateway的请求。</span></p><p><img src="assets/image-20210716153250134.png" referrerpolicy="no-referrer" alt="image-20210716153250134"></p><p><span>配置如下：</span></p><p><img src="assets/image-20210716153301069.png" referrerpolicy="no-referrer" alt="image-20210716153301069"></p><p><span>现在，我们直接跳过网关，访问order-service服务：</span></p><p><img src="assets/image-20210716153348396.png" referrerpolicy="no-referrer" alt="image-20210716153348396"></p><p><span>通过网关访问：</span></p><p><img src="assets/image-20210716153434095.png" referrerpolicy="no-referrer" alt="image-20210716153434095"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='42自定义异常结果'><span>4.2.自定义异常结果</span></h2><p><span>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</span></p><p>&nbsp;</p><h3 id='421异常类型'><span>4.2.1.异常类型</span></h3><p>&nbsp;</p><p><span>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.7998px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>6</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">BlockExceptionHandler</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 处理请求被限流、降级、授权拦截时抛出的异常：BlockException</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 21px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-variable">handle</span>(<span class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span>, <span class="cm-variable">HttpServletResponse</span> <span class="cm-variable">response</span>, <span class="cm-variable">BlockException</span> <span class="cm-variable">e</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 21px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 307px;"></div><div class="CodeMirror-gutters" style="height: 307px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 29px;"></div></div></div></div></pre><p><span>这个方法有三个参数：</span></p><ul><li><span>HttpServletRequest request：request对象</span></li><li><span>HttpServletResponse response：response对象</span></li><li><span>BlockException e：被sentinel拦截时抛出的异常</span></li></ul><p><span>这里的BlockException包含多个不同的子类：</span></p><figure><table><thead><tr><th><strong><span>异常</span></strong></th><th><strong><span>说明</span></strong></th></tr></thead><tbody><tr><td><span>FlowException</span></td><td><span>限流异常</span></td></tr><tr><td><span>ParamFlowException</span></td><td><span>热点参数限流的异常</span></td></tr><tr><td><span>DegradeException</span></td><td><span>降级异常</span></td></tr><tr><td><span>AuthorityException</span></td><td><span>授权规则异常</span></td></tr><tr><td><span>SystemBlockException</span></td><td><span>系统规则异常</span></td></tr></tbody></table></figure><p>&nbsp;</p><h3 id='422自定义异常处理'><span>4.2.2.自定义异常处理</span></h3><p><span>下面，我们就在order-service定义一个自定义异常处理类：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.7998px; left: 44px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 40px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>36</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -40px; width: 40px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">package</span> <span class="cm-def">cn</span>.<span class="cm-variable">itcast</span>.<span class="cm-variable">order</span>.<span class="cm-variable">sentinel</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">alibaba</span>.<span class="cm-variable">csp</span>.<span class="cm-variable">sentinel</span>.<span class="cm-variable">adapter</span>.<span class="cm-variable">spring</span>.<span class="cm-variable">webmvc</span>.<span class="cm-variable">callback</span>.<span class="cm-variable">BlockExceptionHandler</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">alibaba</span>.<span class="cm-variable">csp</span>.<span class="cm-variable">sentinel</span>.<span class="cm-variable">slots</span>.<span class="cm-variable">block</span>.<span class="cm-variable">BlockException</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">alibaba</span>.<span class="cm-variable">csp</span>.<span class="cm-variable">sentinel</span>.<span class="cm-variable">slots</span>.<span class="cm-variable">block</span>.<span class="cm-variable">authority</span>.<span class="cm-variable">AuthorityException</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">alibaba</span>.<span class="cm-variable">csp</span>.<span class="cm-variable">sentinel</span>.<span class="cm-variable">slots</span>.<span class="cm-variable">block</span>.<span class="cm-variable">degrade</span>.<span class="cm-variable">DegradeException</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">alibaba</span>.<span class="cm-variable">csp</span>.<span class="cm-variable">sentinel</span>.<span class="cm-variable">slots</span>.<span class="cm-variable">block</span>.<span class="cm-variable">flow</span>.<span class="cm-variable">FlowException</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">alibaba</span>.<span class="cm-variable">csp</span>.<span class="cm-variable">sentinel</span>.<span class="cm-variable">slots</span>.<span class="cm-variable">block</span>.<span class="cm-variable">flow</span>.<span class="cm-variable">param</span>.<span class="cm-variable">ParamFlowException</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">stereotype</span>.<span class="cm-variable">Component</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">servlet</span>.<span class="cm-variable">http</span>.<span class="cm-variable">HttpServletRequest</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">servlet</span>.<span class="cm-variable">http</span>.<span class="cm-variable">HttpServletResponse</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">14</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Component</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">15</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">SentinelExceptionHandler</span> <span class="cm-keyword">implements</span> <span class="cm-variable">BlockExceptionHandler</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">16</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">17</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">handle</span>(<span class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span>, <span class="cm-variable">HttpServletResponse</span> <span class="cm-variable">response</span>, <span class="cm-variable">BlockException</span> <span class="cm-variable">e</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">18</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">msg</span> <span class="cm-operator">=</span> <span class="cm-string">"未知异常"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">19</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">status</span> <span class="cm-operator">=</span> <span class="cm-number">429</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">20</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">21</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">e</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">FlowException</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">22</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">msg</span> <span class="cm-operator">=</span> <span class="cm-string">"请求被限流了"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">23</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">e</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">ParamFlowException</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">24</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">msg</span> <span class="cm-operator">=</span> <span class="cm-string">"请求被热点参数限流"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">25</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">e</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">DegradeException</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">26</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">msg</span> <span class="cm-operator">=</span> <span class="cm-string">"请求被降级了"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">27</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">e</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">AuthorityException</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">28</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">msg</span> <span class="cm-operator">=</span> <span class="cm-string">"没有权限访问"</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">29</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">status</span> <span class="cm-operator">=</span> <span class="cm-number">401</span>;</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">30</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">31</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">32</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">response</span>.<span class="cm-variable">setContentType</span>(<span class="cm-string">"application/json;charset=utf-8"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">33</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">response</span>.<span class="cm-variable">setStatus</span>(<span class="cm-variable">status</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">34</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">response</span>.<span class="cm-variable">getWriter</span>().<span class="cm-variable">println</span>(<span class="cm-string">"{\"msg\": "</span> <span class="cm-operator">+</span> <span class="cm-variable">msg</span> <span class="cm-operator">+</span> <span class="cm-string">", \"status\": "</span> <span class="cm-operator">+</span> <span class="cm-variable">status</span> <span class="cm-operator">+</span> <span class="cm-string">"}"</span>);</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 32px;">35</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -40px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 32px;">36</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 2099px;"></div><div class="CodeMirror-gutters" style="height: 2099px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 40px;"></div></div></div></div></pre><p>&nbsp;</p><p><span>重启测试，在不同场景下，会返回不同的异常消息.</span></p><p><span>限流：</span></p><p><img src="assets/image-20210716153938887.png" referrerpolicy="no-referrer" alt="image-20210716153938887"></p><p><span>授权拦截时：</span></p><p><img src="assets/image-20210716154012736.png" referrerpolicy="no-referrer" alt="image-20210716154012736"></p><p>&nbsp;</p><p>&nbsp;</p><h1 id='5规则持久化'><span>5.规则持久化</span></h1><p><span>现在，sentinel的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</span></p><h2 id='51规则管理模式'><span>5.1.规则管理模式</span></h2><p><span>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：</span></p><ul><li><span>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。</span></li><li><span>pull模式</span></li><li><span>push模式</span></li></ul><p>&nbsp;</p><h3 id='511pull模式'><span>5.1.1.pull模式</span></h3><p><span>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</span></p><p><img src="assets/image-20210716154155238.png" referrerpolicy="no-referrer" alt="image-20210716154155238"></p><p>&nbsp;</p><h3 id='512push模式'><span>5.1.2.push模式</span></h3><p><span>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。</span></p><p><img src="assets/image-20210716154215456.png" referrerpolicy="no-referrer" alt="image-20210716154215456"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='52实现push模式'><span>5.2.实现push模式</span></h2><p><span>详细步骤可以参考课前资料的《sentinel规则持久化》：</span></p><p><img src="assets/image-20210716154255466.png" referrerpolicy="no-referrer" alt="image-20210716154255466"></p></div></div>

<script>(function(){var e=document.body.parentElement,t=[],n=null,i=document.body.classList.contains("typora-export-collapse-outline"),r=function(e,t,n){document.addEventListener(e,function(e){if(!e.defaultPrevented)for(var i=e.target;i&&i!=this;i=i.parentNode)if(i.matches(t)){!1===n.call(i,e)&&(e.preventDefault(),e.stopPropagation());break}},!1)};function o(){return e.scrollTop}r("click",".outline-expander",function(e){var t=this.closest(".outline-item-wrapper").classList;return t.contains("outline-item-open")?t.remove("outline-item-open"):t.add("outline-item-open"),d(),!1}),r("click",".outline-item",function(e){var t=this.querySelector(".outline-label");if(location.hash="#"+t.getAttribute("href"),i){var n=this.closest(".outline-item-wrapper").classList;n.contains("outline-item-open")||n.add("outline-item-open"),c(),n.add("outline-item-active")}});var a,s,l=function(){var e=o();n=null;for(var i=0;i<t.length&&t[i][1]-e<60;i++)n=t[i]},c=function(){document.querySelectorAll(".outline-item-active").forEach(e=>e.classList.remove("outline-item-active")),document.querySelectorAll(".outline-item-single.outline-item-open").forEach(e=>e.classList.remove("outline-item-open"))},d=function(){if(n){c();var e=document.querySelector('.outline-label[href="#'+(CSS.escape?CSS.escape(n[0]):n[0])+'"]');if(e)if(i){var t=e.closest(".outline-item-open>ul>.outline-item-wrapper");if(t)t.classList.add("outline-item-active");else{for(var r=(e=e.closest(".outline-item-wrapper")).parentElement.closest(".outline-item-wrapper");r;)r=(e=r).parentElement.closest(".outline-item-wrapper");e.classList.add("outline-item-active")}}else e.closest(".outline-item-wrapper").classList.add("outline-item-active")}};window.addEventListener("scroll",function(e){a&&clearTimeout(a),a=setTimeout(function(){l(),d()},300)});var u=function(){s=setTimeout(function(){!function(){t=[];var e=o();document.querySelector("#write").querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(n=>{var i=n.getAttribute("id");t.push([i,e+n.getBoundingClientRect().y])})}(),l(),d()},300)};window.addEventListener("resize",function(e){s&&clearTimeout(s),u()}),u()})();</script><a id="O-switch" style="width: 50px; height: 50px; text-align: center; line-height:50px; position:fixed; bottom:0; opacity: 0.3;" title="显示/隐藏目录">〇</a>

<script>
var sidebar = document.getElementsByClassName("typora-export-sidebar")[0];var button = document.getElementById("O-switch");sidebar.style.display='none';button.onclick=function(){if(sidebar.style.display=='block')sidebar.style.display='none';else sidebar.style.display='block'};
</script></body>
</html>